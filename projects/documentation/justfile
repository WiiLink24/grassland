set unstable
set script-interpreter := ["nu"]

# Default recipe of the justfile
default: help

# Show this info message
help:
    just --list

# Setup the environment of the project
[script]
setup:
    rm -rf .venv
    python3 -m venv .venv
    .venv/bin/pip3 install -r requirements.txt

# Check, lint and format all files
[script]
check:
    # Do nothing, only here to report to the main monorepo justfile
    # that there is no checks in this project

# Generate the index file from the README in the given path
[script]
generate-index path:
    const docs_index_path = "{{path}}/docs/index.md"

    rm -f $docs_index_path
    touch $docs_index_path

    "<!-- WARNING: MACHINE GENERATED FILE, DO NOT EDIT!!! -->\n" | save --append $docs_index_path
    "<!-- To generate this file run `just generate-indices` at `/projects/documentation/` in the monorepo -->\n\n" | save --append $docs_index_path

    open $"{{path}}/README.md" | save --append $docs_index_path

# Generate the index files for all documentation directories
[script]
generate-indices:
    just generate-index ../..

    ls .. | where type == dir | each { |project|
        just generate-index $project.name
    }

# Run the monorepo documentation
[script]
serve: generate-indices
    # Serve the root MkDocs file of the repo
    .venv/bin/mkdocs serve -f ../../mkdocs.yml

# Build the Docker image of the documentation. Mostly used in the CI/CD
[script]
build-docker-image tag:
    # To avoid polluting the root of the project with unnecessary files
    # we tell Docker to use the Dockerfile located at this project but trick it
    # by setting the CWD to the root of the repo so we can copy any file

    # Unfortunately an equivalent option for the `.dockerignore` file is not available
    # so we can only make a temporal copy of it and then remove it

    # Without this trick building the image can take multiple seconds
    # and any edit (even internally by Git as the `.git` directory is al tracked)
    # will invalidate the cache of the layer

    cp .dockerignore ../..
    cd ../..

    docker build -t ghcr.io/kutu-dev/documentation:{{tag}} -f projects/documentation/Dockerfile .

    rm .dockerignore
